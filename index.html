<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ZetGram ‚Äî Chat</title>

<!-- –°—Ç–∏–ª–∏ -->
<style>
:root{
  --bg:#1a0000; --panel:#2a0f0f; --accent:#b30000; --accent-2:#ff4c4c; --muted:#ff9999;
  --glass: rgba(255,255,255,0.03);
  --nice: #ffefef;
}
*{box-sizing:border-box}
html,body{height:100%; margin:0; font-family: Inter,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--nice); -webkit-font-smoothing:antialiased}
.app{
  height:100vh; display:flex; flex-direction:column;
}
/* header */
.header{
  display:flex; align-items:center; justify-content:space-between;
  padding:12px 16px; background:linear-gradient(90deg,var(--accent),#7e0000);
  box-shadow: 0 3px 10px rgba(0,0,0,0.5);
}
.header .title{font-weight:700; font-size:18px}
.header .user-info{display:flex; gap:10px; align-items:center}

/* layout */
.container{
  flex:1; display:flex; gap:12px; padding:12px;
}
/* sidebar users */
.sidebar{
  width:220px; max-width:30%;
  background:var(--panel); border-radius:12px; padding:12px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.4);
  display:flex; flex-direction:column;
}
.sidebar h3{margin:0 0 10px 0; color:var(--accent-2)}
.users-list{overflow:auto; flex:1; display:flex; flex-direction:column; gap:8px; padding-right:6px}
.user-row{display:flex; gap:8px; align-items:center; padding:8px; border-radius:8px; cursor:default}
.user-row .avatar{width:40px;height:40px;border-radius:8px; display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff}
.user-row .meta{display:flex;flex-direction:column}
.user-row .meta .name{font-weight:600}
.user-row .status{font-size:12px; color:var(--muted)}

/* main chat panel */
.panel{
  flex:1; display:flex; flex-direction:column; border-radius:12px; background: linear-gradient(180deg,#240606,#2a0f0f);
  padding:10px; box-shadow: 0 8px 30px rgba(0,0,0,0.6);
  min-width:320px;
}

/* message area */
.messages{
  flex:1; overflow:auto; padding:12px; display:flex; flex-direction:column; gap:10px;
  scroll-behavior:smooth;
}
.message{
  max-width:72%; padding:10px 12px; border-radius:12px; position:relative;
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
  word-break:break-word; background: #4a0a0a;
}
.message.mine{align-self:flex-end; background: linear-gradient(180deg,var(--accent),#8b0000)}
.message .meta{display:flex; gap:8px; align-items:center; margin-bottom:6px}
.avatar-sm{width:36px;height:36px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center;font-weight:700;color:white}
.author{font-weight:700; color:var(--accent-2)}
.time{font-size:12px;color:var(--muted); margin-left:6px}
.msg-text{font-size:15px; margin-bottom:6px}
.msg-img{display:block; max-width:320px; border-radius:8px; margin-top:6px; box-shadow: 0 6px 16px rgba(0,0,0,0.5)}

/* delete button */
.del-btn{position:absolute; top:6px; right:6px; background:transparent; border:none; color:var(--muted); font-weight:700; cursor:pointer}

/* input area fixed bottom inside panel */
.input-bar{
  display:flex; gap:8px; align-items:center; margin-top:8px; padding-top:8px; border-top:1px solid rgba(255,0,0,0.06)
}
.input-field{
  flex:1; display:flex; gap:8px; align-items:center; background:var(--glass); padding:8px; border-radius:10px;
}
textarea{flex:1; resize:none; padding:8px; border-radius:8px; background:transparent; border:none; color:var(--nice); outline:none; font-size:15px}
.file-btn{background:transparent; border:2px dashed rgba(255,255,255,0.06); padding:6px;border-radius:8px; color:var(--muted); cursor:pointer}
.send-btn{background:linear-gradient(90deg,var(--accent),#ff3b3b); border:none; color:white; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:700}

/* responsive */
@media(max-width:880px){
  .container{padding:8px}
  .sidebar{display:none}
  .panel{min-width:0}
  .ad{right:8px; top:8px; width:150px}
}

/* Auth modal styles */
.auth-modal {
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background: rgba(26, 0, 0, 0.85);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 999999;
  backdrop-filter: blur(8px);
}
.auth-modal-content {
  background: #2a0f0f;
  border-radius: 12px;
  padding: 32px 28px 24px;
  width: 360px;
  box-shadow:
    0 0 20px 3px #b30000aa,
    0 0 40px 10px #ff4c4c88;
  border: 2px solid #b30000;
  color: #ffefef;
  font-family: Inter, 'Segoe UI', Roboto, Arial, sans-serif;
  user-select: none;
}
.auth-title {
  margin: 0 0 18px;
  font-weight: 700;
  font-size: 24px;
  text-align: center;
  text-shadow: 0 0 6px #ff4c4ccc;
}
.auth-form {
  display: flex;
  flex-direction: column;
  gap: 14px;
}
.auth-label {
  font-weight: 600;
  font-size: 14px;
  color: #ff9999cc;
  margin-bottom: 4px;
}
.auth-input {
  padding: 10px 12px;
  border-radius: 8px;
  border: 1.5px solid #b30000;
  background: #3a1111;
  color: #ffefef;
  font-size: 16px;
  outline-offset: 2px;
  outline-color: transparent;
  transition: outline-color 0.2s ease;
}
.auth-input:focus {
  outline-color: #ff4c4c;
  background: #4a0a0a;
}
.auth-btn {
  margin-top: 12px;
  padding: 12px;
  background: linear-gradient(90deg, #b30000, #ff4c4c);
  border: none;
  border-radius: 10px;
  color: white;
  font-weight: 700;
  font-size: 16px;
  cursor: pointer;
  box-shadow: 0 0 8px #ff4c4caa;
  transition: background 0.3s ease;
}
.auth-btn:hover {
  background: linear-gradient(90deg, #ff4c4c, #b30000);
}
.auth-toggle a {
  color: #ff4c4c;
  text-decoration: none;
  cursor: pointer;
  font-weight: 600;
}
.auth-toggle a:hover {
  text-decoration: underline;
}
.auth-error {
  margin-top: 12px;
  color: #ff5555;
  font-weight: 700;
  text-align: center;
  min-height: 20px;
}
</style>
</head>
<body>
<div class="app" role="application" aria-label="ZetGram chat">
  <div class="header" role="banner">
    <div class="title">ZetGram üî¥</div>
    <div class="user-info" id="headerUser">
      <!-- logged user -->
    </div>
  </div>

  <div class="container">
    <div class="sidebar" aria-label="–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π">
      <h3>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
      <div class="users-list" id="usersList"></div>
      <div style="margin-top:8px; text-align:center; color:var(--muted); font-size:13px">–û–Ω–ª–∞–π–Ω/–≤ —Å–µ—Ç–∏</div>
    </div>

    <div class="panel" role="main">
      <div class="messages" id="messages" aria-live="polite"></div>

      <div class="input-bar" role="region" aria-label="–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è">
        <div class="input-field">
          <textarea id="textInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å, Shift+Enter ‚Äî –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞)"></textarea>
          <input id="fileInput" class="file-btn" type="file" accept="image/*" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" />
        </div>
        <button class="send-btn" id="sendBtn" aria-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <div class="ad" id="adBanner" aria-hidden="false">
    <div class="close" id="closeAd">‚úï</div>
    <!-- AADS iframe -->
    <iframe data-aa="2406373" src="//acceptable.a-ads.com/2406373/?size=Adaptive" referrerpolicy="no-referrer"></iframe>
  </div>
</div>

<!-- Auth modal -->
<div id="authModal" class="auth-modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="authTitle" style="display:none;">
  <div class="auth-modal-content">
    <h2 id="authTitle" class="auth-title">–í—Ö–æ–¥ –≤ ZetGram</h2>
    <form id="authForm" autocomplete="off" class="auth-form">
      <label for="emailInput" class="auth-label">Email</label>
      <input type="email" id="emailInput" class="auth-input" required autocomplete="username" />

      <label for="passInput" class="auth-label">–ü–∞—Ä–æ–ª—å</label>
      <input type="password" id="passInput" class="auth-input" required autocomplete="current-password" />

      <label for="nickInput" id="nicknameLabel" class="auth-label" style="display:none;">–ù–∏–∫ (–¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)</label>
      <input type="text" id="nickInput" class="auth-input" style="display:none;" autocomplete="nickname" />

      <button type="submit" class="auth-btn">–í–æ–π—Ç–∏</button>
    </form>
    <div class="auth-toggle" style="margin-top:12px; text-align:center;">
      <a href="#" id="toggleAuth">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
    </div>
    <div id="authError" class="auth-error" role="alert" aria-live="assertive"></div>
  </div>
</div>

<!-- Firebase SDK (modular) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import {
    getAuth,
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    onAuthStateChanged,
    signOut,
    updateProfile
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import {
    getDatabase,
    ref,
    push,
    onChildAdded,
    onChildRemoved,
    query,
    orderByChild,
    set,
    serverTimestamp,
    onValue,
    get,
    remove,
    onDisconnect
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";
  import {
    getStorage,
    ref as storageRef,
    uploadBytes,
    getDownloadURL
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js";

  // ---------- CONFIG ----------
  const firebaseConfig = {
    apiKey: "AIzaSyDTZrRKHrmKnA9ycBWvt9ephnr7TN6ZFs8",
    authDomain: "zetgram-d2b77.firebaseapp.com",
    databaseURL: "https://zetgram-d2b77-default-rtdb.firebaseio.com",
    projectId: "zetgram-d2b77",
    storageBucket: "zetgram-d2b77.appspot.com",
    messagingSenderId: "804686454",
    appId: "1:804686454:web:db9f618955e3d370deed57",
    measurementId: "G-KCYSRCX4ZL"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);
  const storage = getStorage(app);

  // ---------- UI references ----------
  const messagesEl = document.getElementById('messages');
  const textInput = document.getElementById('textInput');
  const fileInput = document.getElementById('fileInput');
  const sendBtn = document.getElementById('sendBtn');
  const usersListEl = document.getElementById('usersList');
  const headerUser = document.getElementById('headerUser');
  const adBanner = document.getElementById('adBanner');
  const closeAd = document.getElementById('closeAd');

  const authModal = document.getElementById('authModal');
  const authForm = document.getElementById('authForm');
  const emailInput = document.getElementById('emailInput');
  const passInput = document.getElementById('passInput');
  const nickInput = document.getElementById('nickInput');
  const nicknameLabel = document.getElementById('nicknameLabel');
  const toggleAuthLink = document.getElementById('toggleAuth');
  const authError = document.getElementById('authError');

  closeAd.addEventListener('click', ()=> adBanner.style.display='none');

  // --------- small helpers ----------
  function el(tag, cls, txt){
    const e = document.createElement(tag);
    if(cls) e.className = cls;
    if(txt !== undefined) e.textContent = txt;
    return e;
  }
  function timeString(ts){
    const d = new Date(ts);
    return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  }
  function initials(name){
    if(!name) return '??';
    return name.split(' ').map(s=>s[0]?.toUpperCase()||'').slice(0,2).join('');
  }
  function colorFromString(s){
    let h=0; for(let i=0;i<s.length;i++) h = (h<<5)-h + s.charCodeAt(i);
    const hue = Math.abs(h)%360;
    return `hsl(${hue} 80% 35%)`;
  }

  // ---------- Presence & users ----------
  const displayedUsers = new Map(); // uid->node
  function renderUser(uid, data){
    let row = displayedUsers.get(uid);
    if(!row){
      row = el('div','user-row');
      const av = el('div','avatar');
      av.style.width = '40px'; av.style.height='40px'; av.style.borderRadius='8px'; av.style.display='flex'; av.style.alignItems='center'; av.style.justifyContent='center';
      av.style.fontWeight='700';
      av.style.color='#fff';
      av.style.background = colorFromString(data.username||uid);
      av.textContent = initials(data.username||'U');
      const meta = el('div','meta');
      const name = el('div','name', data.username||'–ë–µ–∑ –∏–º–µ–Ω–∏');
      const status = el('div','status', data.online ? '–æ–Ω–ª–∞–π–Ω' : `–ø–æ—Å–ª–µ–¥–Ω–∏–π: ${data.lastSeen ? new Date(data.lastSeen).toLocaleString() : '‚Äî'}`);
      status.style.color='var(--muted)';
      meta.appendChild(name); meta.appendChild(status);
      row.appendChild(av); row.appendChild(meta);
      usersListEl.appendChild(row);
      displayedUsers.set(uid,row);
    } else {
      // update status
      const name = row.querySelector('.meta .name');
      const status = row.querySelector('.meta .status');
      if(name) name.textContent = data.username||'–ë–µ–∑ –∏–º–µ–Ω–∏';
      if(status) status.textContent = data.online ? '–æ–Ω–ª–∞–π–Ω' : `–ø–æ—Å–ª–µ–¥–Ω–∏–π: ${data.lastSeen ? new Date(data.lastSeen).toLocaleString() : '‚Äî'}`;
    }
  }

  // listen users list
  const usersRef = ref(db, 'users');
  onValue(usersRef, snapshot=>{
    const v = snapshot.val() || {};
    // remove DOM nodes not in v
    const uids = Object.keys(v);
    // render each
    uids.forEach(uid => {
      renderUser(uid, v[uid]);
    });
    // remove old
    for(const [uid,node] of displayedUsers){
      if(!v[uid]) { node.remove(); displayedUsers.delete(uid); }
    }
  });

  // ---------- messages ----------
  function renderMessage(key, msg, isMine=false){
    if(!msg) return;
    const div = el('div','message');
    if(isMine) div.classList.add('mine');
    div.dataset.key = key;

    const meta = el('div','meta');
    const av = el('div','avatar-sm');
    av.style.background = colorFromString(msg.username||'U');
    av.textContent = initials(msg.username||'U');

    const author = el('div','author', msg.username || '–ë–µ–∑ –∏–º–µ–Ω–∏');
    const timeEl = el('div','time', timeString(msg.timestamp||Date.now()));

    meta.appendChild(av);
    meta.appendChild(author);
    meta.appendChild(timeEl);

    div.appendChild(meta);

    if(msg.text){
      const text = el('div','msg-text');
      text.textContent = msg.text;
      div.appendChild(text);
    }
    if(msg.image){
      const img = document.createElement('img');
      img.className = 'msg-img';
      img.src = msg.image;
      img.alt = '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
      div.appendChild(img);
    }

    // delete button if mine
    if(isMine){
      const delBtn = el('button','del-btn','√ó');
      delBtn.setAttribute('aria-label','–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ');
      delBtn.addEventListener('click', ()=>{
        const messageRef = ref(db, 'messages/' + key);
        remove(messageRef).catch(console.error);
      });
      div.appendChild(delBtn);
    }

    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  // listen messages
  const messagesRef = ref(db, 'messages');
  onChildAdded(messagesRef, (data) => {
    const msg = data.val();
    renderMessage(data.key, msg, msg.uid === auth.currentUser?.uid);
  });
  onChildRemoved(messagesRef, (data) => {
    const elToRemove = messagesEl.querySelector(`[data-key="${data.key}"]`);
    if(elToRemove) elToRemove.remove();
  });

  // ---------- send message ----------
  async function sendMessage(){
    const txt = textInput.value.trim();
    if(!txt && !fileInput.files.length) return;

    sendBtn.disabled = true;

    let imageUrl = null;
    if(fileInput.files.length){
      const file = fileInput.files[0];
      const storagePath = 'images/' + auth.currentUser.uid + '/' + Date.now() + '_' + file.name;
      const storageReference = storageRef(storage, storagePath);
      await uploadBytes(storageReference, file);
      imageUrl = await getDownloadURL(storageReference);
      fileInput.value = '';
    }

    const msgData = {
      uid: auth.currentUser.uid,
      username: auth.currentUser.displayName || auth.currentUser.email.split('@')[0],
      text: txt || null,
      image: imageUrl || null,
      timestamp: serverTimestamp()
    };
    await push(ref(db,'messages'), msgData);
    textInput.value = '';
    sendBtn.disabled = false;
    textInput.focus();
  }

  sendBtn.addEventListener('click', e => {
    e.preventDefault();
    sendMessage();
  });

  textInput.addEventListener('keydown', e=>{
    if(e.key==='Enter' && !e.shiftKey){
      e.preventDefault();
      sendMessage();
    }
  });

  // ---------- presence ----------
  function updatePresence(online){
    if(!auth.currentUser) return;
    const userRef = ref(db, 'users/' + auth.currentUser.uid);
    if(online){
      set(userRef, {
        username: auth.currentUser.displayName || auth.currentUser.email.split('@')[0],
        online: true,
        lastSeen: serverTimestamp()
      });
      onDisconnect(userRef).update({online:false, lastSeen: serverTimestamp()});
    } else {
      set(userRef, {online:false, lastSeen: serverTimestamp()});
    }
  }

  // ---------- auth UI ----------
  let isRegisterMode = false;

  function showAuthModal(show){
    authModal.style.display = show ? 'flex' : 'none';
    authModal.setAttribute('aria-hidden', show ? 'false' : 'true');
  }

  function toggleAuthMode(){
    isRegisterMode = !isRegisterMode;
    if(isRegisterMode){
      authModal.querySelector('.auth-title').textContent = '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ ZetGram';
      authForm.querySelector('button[type=submit]').textContent = '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
      nicknameLabel.style.display = 'block';
      nickInput.style.display = 'block';
      toggleAuthLink.textContent = '–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏';
      authError.textContent = '';
    } else {
      authModal.querySelector('.auth-title').textContent = '–í—Ö–æ–¥ –≤ ZetGram';
      authForm.querySelector('button[type=submit]').textContent = '–í–æ–π—Ç–∏';
      nicknameLabel.style.display = 'none';
      nickInput.style.display = 'none';
      toggleAuthLink.textContent = '–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
      authError.textContent = '';
    }
  }

  toggleAuthLink.addEventListener('click', e=>{
    e.preventDefault();
    toggleAuthMode();
  });

  authForm.addEventListener('submit', async e=>{
    e.preventDefault();
    authError.textContent = '';
    const email = emailInput.value.trim();
    const pass = passInput.value;
    const nick = nickInput.value.trim();

    try{
      if(isRegisterMode){
        // —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
        const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
        await updateProfile(userCredential.user, {displayName: nick || email.split('@')[0]});
        // update presence here
        updatePresence(true);
        showAuthModal(false);
      } else {
        // –≤—Ö–æ–¥
        const userCredential = await signInWithEmailAndPassword(auth, email, pass);
        updatePresence(true);
        showAuthModal(false);
      }
    } catch(err){
      // –ø–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É –≤ –º–æ–¥–∞–ª–∫–µ
      let msg = '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏';
      if(err.code === 'auth/wrong-password') msg = '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å';
      else if(err.code === 'auth/user-not-found') msg = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω';
      else if(err.code === 'auth/email-already-in-use') msg = 'Email —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è';
      else if(err.code === 'auth/invalid-email') msg = '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email';
      else if(err.code === 'auth/weak-password') msg = '–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º —Å–ª–∞–±—ã–π (–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤)';
      authError.textContent = msg;
    }
  });

  // ---------- auth state observer ----------
  onAuthStateChanged(auth, user => {
    if(user){
      headerUser.textContent = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ' + (user.displayName || user.email);
      showAuthModal(false);
      updatePresence(true);
    } else {
      headerUser.textContent = '';
      updatePresence(false);
      showAuthModal(true);
    }
  });

  // Clean presence on tab close
  window.addEventListener('beforeunload', ()=>{
    updatePresence(false);
  });
</script>
</body>
</html>
